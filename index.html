<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF.js Viewer with Highlighting</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <style>
        canvas { border: 1px solid black; display: block; margin-bottom: 10px; }
    </style>
</head>
<body>
    <h2>PDF.js Viewer</h2>
    <input type="file" id="uploadPDF" accept="application/pdf" style="display: none;">
    <div id="pdfContainer"></div>

    <script>
        const useUpload = false; // Change this to true to enable manual upload
        const hardcodedPDF = 'VRRENEWAL-5.pdf'; // Replace with your local or hosted PDF path

        const highlightData = [
            { "page": 1, "offset": 10, "length": 15 },
            { "page": 1, "offset": 250, "length": 500 },
            { "page": 2, "offset": 5, "length": 30 }
        ];

        if (useUpload) {
            document.getElementById('uploadPDF').style.display = 'block';
            document.getElementById('uploadPDF').addEventListener('change', function(event) {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        const typedarray = new Uint8Array(event.target.result);
                        renderPDF(typedarray);
                    };
                    reader.readAsArrayBuffer(file);
                }
            });
        } else {
            fetch(hardcodedPDF)
                .then(response => response.arrayBuffer())
                .then(data => renderPDF(new Uint8Array(data)))
                .catch(error => console.error('Failed to load hardcoded PDF:', error));
        }

        function renderPDF(data) {
            pdfjsLib.getDocument({ data }).promise.then(pdf => {
                for (let i = 1; i <= pdf.numPages; i++) {
                    pdf.getPage(i).then(page => {
                        renderPageWithHighlights(page, i);
                    });
                }
            }).catch(error => {
                console.error("Error loading PDF: ", error);
            });
        }

        function renderPageWithHighlights(page, pageNum) {
            const scale = 1.5;
            const viewport = page.getViewport({ scale });
            const canvas = document.createElement("canvas");
            const context = canvas.getContext("2d");
            canvas.width = viewport.width;
            canvas.height = viewport.height;
            document.getElementById('pdfContainer').appendChild(canvas);

            const renderContext = {
                canvasContext: context,
                viewport: viewport
            };

            page.render(renderContext).promise.then(() => {
                page.getTextContent().then(textContent => {
                    highlightText(context, textContent, pageNum, viewport, scale);
                });
            });
        }

        function highlightText(context, textContent, pageNum, viewport, scale) {
            let charCount = 0;
            const highlights = highlightData.filter(h => h.page === pageNum);

            textContent.items.forEach(textItem => {
                let text = textItem.str;
                const tx = pdfjsLib.Util.transform(viewport.transform, textItem.transform);
                const x = tx[4];
                const y = tx[5] - textItem.height;
                const charWidth = (textItem.width * scale) / text.length;

                highlights.forEach(annotation => {
                    let startOffset = annotation.offset - charCount;
                    let endOffset = startOffset + annotation.length;

                    if (startOffset < text.length && endOffset > 0) {
                        const start = Math.max(startOffset, 0);
                        const end = Math.min(endOffset, text.length);
                        for (let i = start; i < end; i++) {
                            const charX = x + charWidth * i;
                            context.fillStyle = "yellow";
                            context.globalAlpha = 0.5;
                            context.fillRect(charX, y, charWidth, textItem.height);
                        }
                    }
                });

                charCount += text.length;
            });
        }
    </script>
</body>
</html>
